<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŠ•ç¨¿ä¸€è¦§ | SenpaiNet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; color: #333; }
    .navbar { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
    .navbar-container { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
    .navbar-logo a { font-weight: bold; font-size: 1.5rem; color: #2563eb; text-decoration: none; }
    .navbar-menu a { margin-left: 20px; text-decoration: none; color: #555; font-size: 0.95rem; transition: color 0.2s; }
    .navbar-menu a:hover, .navbar-menu a.active { color: #2563eb; font-weight: bold; }
    
    main { max-width: 800px; margin: 30px auto; padding: 0 20px; }
    
    .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 15px; }
    .header h1 { font-size: 1.8rem; font-weight: bold; color: #1f2937; margin: 0; }
    
    .search-bar { display: flex; gap: 10px; flex-grow: 1; max-width: 400px; }
    .search-bar input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
    .search-bar button { padding: 10px 20px; background: #4b5563; color: white; border: none; border-radius: 6px; cursor: pointer; }
    
    .new-post-btn { display: inline-block; background: #2563eb; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; transition: background 0.2s; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
    .new-post-btn:hover { background: #1d4ed8; }

    .post-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.1s; }
    .post-header { display: flex; justify-content: space-between; color: #6b7280; font-size: 0.9rem; margin-bottom: 10px; }
    .post-title { font-size: 1.4rem; font-weight: bold; margin: 0 0 10px 0; color: #111; }
    .post-content { font-size: 1rem; line-height: 1.6; color: #374151; margin-bottom: 15px; white-space: pre-wrap; }
    .post-tags { margin-bottom: 20px; font-size: 0.9rem; }
    .tag-pill { display: inline-block; background: #e0f2fe; color: #0284c7; padding: 4px 10px; border-radius: 15px; margin-right: 5px; margin-bottom: 5px; }

    .comments-section { background: #f9fafb; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e5e7eb; }
    .comments-section h4 { font-size: 1rem; margin: 0 0 15px 0; color: #4b5563; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .comment-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
    .comment-item:last-child { border-bottom: none; }
    .comment-meta { font-size: 0.85rem; color: #6b7280; margin-bottom: 4px; display: flex; justify-content: space-between; }
    .comment-body { font-size: 0.95rem; color: #333; }

    .comment-form textarea { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 0.95rem; min-height: 60px; margin-bottom: 10px; resize: vertical; }
    .comment-controls { display: flex; justify-content: space-between; align-items: center; }
    .submit-comment-btn { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
    .submit-comment-btn:hover { background: #059669; }
    .anonymous-label { font-size: 0.9rem; color: #555; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    
    .loading-state { opacity: 0.5; pointer-events: none; }

    @media (max-width: 600px) {
      .header { flex-direction: column; align-items: stretch; }
      .search-bar { max-width: 100%; }
      .new-post-btn { text-align: center; }
    }
  </style>
</head>
<body class="list-page">

  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <a href="archive.html">SenpaiNet</a>
      </div>
      <nav class="navbar-menu">
        <a href="post.html">ç›¸è«‡ã™ã‚‹</a>
        <a href="archive.html" class="active">ç›¸è«‡ã‚’è¦‹ã‚‹</a>
        <a href="#">å®Ÿç¸¾</a>
        <a href="signup.html" class="account-link">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="header">
      <h1>ğŸŒ ã¿ã‚“ãªã®ç›¸è«‡ä¸€è¦§</h1>
      <div class="search-bar">
        <input type="text" id="keywordInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢">
        <button id="searchBtn">æ¤œç´¢</button>
      </div>
      <a href="post.html" class="new-post-btn">ï¼‹ æ–°ã—ãæŠ•ç¨¿</a>
    </section>

    <section class="post-list" id="postList">
      <div style="text-align:center; padding: 40px; color:#888;">
        èª­ã¿è¾¼ã¿ä¸­...
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwPtYMU_xiM5YgcqfNsCFESkj-Y4ICD5E",
      authDomain: "senpainet-84a24.firebaseapp.com",
      projectId: "senpainet-84a24",
      storageBucket: "senpainet-84a24.firebasestorage.app",
      messagingSenderId: "1053589632945",
      appId: "1:1053589632945:web:413919be47760675e4ef90",
      measurementId: "G-1GPKNSMMFZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    // 1. ç¢ºå®Ÿãªãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
      } else {
        signInAnonymously(auth);
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³ã‚’å¾…æ©Ÿã™ã‚‹é–¢æ•° (ã“ã“ãŒä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ)
    function ensureLogin() {
        return new Promise((resolve) => {
            // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰å³å®Œäº†
            if (auth.currentUser) {
                resolve(auth.currentUser);
                return;
            }
            // ã¾ã ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã¾ã§å¾…ã¤
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    unsubscribe();
                    currentUser = user;
                    resolve(user);
                }
            });
        });
    }

    // 2. æŠ•ç¨¿ä¸€è¦§ãƒ­ã‚¸ãƒƒã‚¯
    const postListElement = document.getElementById('postList');
    const postsRef = collection(db, "posts");
    const q = query(postsRef, orderBy("createdAt", "desc"));

    onSnapshot(q, (snapshot) => {
        postListElement.innerHTML = "";
        if (snapshot.empty) {
            postListElement.innerHTML = "<p style='text-align:center; padding:40px; color:#666;'>ã¾ã ç›¸è«‡ã®æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
            return;
        }

        snapshot.forEach((doc) => {
            const post = doc.data();
            const postId = doc.id;
            const tagsHtml = post.tags ? post.tags.map(t => `<span class="tag-pill">#${t}</span>`).join("") : "";

            const card = document.createElement('div');
            card.className = 'post-card';
            card.innerHTML = `
                <div class="post-header">
                <span class="author">ğŸ‘¤ ${escapeHtml(post.nickname || "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼")}</span>
                <span class="date">${formatDate(post.createdAt)}</span>
                </div>
                <h3 class="post-title">${escapeHtml(post.title || "ç„¡é¡Œ")}</h3>
                <div class="post-content">${escapeHtml(post.content || "")}</div>
                <div class="post-tags">${tagsHtml}</div>
                
                <div class="comments-section">
                <h4>ğŸ’¬ ã¿ã‚“ãªã®å›ç­”</h4>
                <div id="comments-${postId}" class="comment-list">
                    <p style="font-size:0.8em; color:#999;">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
                
                <div class="comment-form">
                    <textarea id="input-${postId}" placeholder="ã“ã®ç›¸è«‡ã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã™ã‚‹..."></textarea>
                    <div class="comment-controls">
                    <label class="anonymous-label">
                        <input type="checkbox" id="anon-${postId}"> åŒ¿åã§å›ç­”
                    </label>
                    <button class="submit-comment-btn" id="btn-${postId}">é€ä¿¡</button>
                    </div>
                </div>
                </div>
            `;
            postListElement.appendChild(card);
            
            loadComments(postId);

            const submitBtn = card.querySelector(`#btn-${postId}`);
            submitBtn.addEventListener('click', () => submitComment(postId, submitBtn));
        });
    });

    function loadComments(postId) {
        const commentsRef = collection(db, "posts", postId, "comments");
        const qComments = query(commentsRef, orderBy("createdAt", "asc"));

        onSnapshot(qComments, (snapshot) => {
            const listDiv = document.getElementById(`comments-${postId}`);
            listDiv.innerHTML = "";

            if (snapshot.empty) {
                listDiv.innerHTML = "<p style='font-size:0.9em; color:#aaa; font-style:italic;'>å›ç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            snapshot.forEach((doc) => {
                const comment = doc.data();
                const div = document.createElement('div');
                div.className = 'comment-item';
                
                let displayName = comment.authorName || "åç„¡ã—";
                if (comment.isAnonymous) displayName = "åŒ¿åå…ˆè¼©";

                div.innerHTML = `
                    <div class="comment-meta">
                    <strong>${escapeHtml(displayName)}</strong>
                    <span>${formatDate(comment.createdAt)}</span>
                    </div>
                    <div class="comment-body" style="white-space: pre-wrap;">${escapeHtml(comment.text)}</div>
                `;
                listDiv.appendChild(div);
            });
        });
    }

    // 3. é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä¿®æ­£ï¼šãƒ­ã‚°ã‚¤ãƒ³å¾…æ©Ÿæ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰
    window.submitComment = async (postId, btnElement) => {
        const input = document.getElementById(`input-${postId}`);
        const text = input.value.trim();
        if (!text) {
            alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            return;
        }

        // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
        btnElement.textContent = "é€ä¿¡ä¸­...";
        btnElement.disabled = true;

        try {
            // â˜… ã“ã“ã§ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å¾…ã¤
            const user = await ensureLogin();

            const anonCheck = document.getElementById(`anon-${postId}`);
            const isAnonymous = anonCheck.checked;

            const commentsRef = collection(db, "posts", postId, "comments");
            await addDoc(commentsRef, {
                text: text,
                authorId: user.uid,
                authorName: user.displayName || "å…ˆè¼©ãƒ¦ãƒ¼ã‚¶ãƒ¼",
                isAnonymous: isAnonymous,
                createdAt: serverTimestamp()
            });
            input.value = ""; 

        } catch (error) {
            console.error("é€ä¿¡ã‚¨ãƒ©ãƒ¼:", error);
            alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        } finally {
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            btnElement.textContent = "é€ä¿¡";
            btnElement.disabled = false;
        }
    };

    function escapeHtml(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
        });
    }

    function formatDate(timestamp) {
        if (!timestamp) return "";
        const d = timestamp.toDate();
        return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>
