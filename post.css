<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SenpaiNetï½œç›¸è«‡ã‚’æŠ•ç¨¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f3f4f6; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box;}
    .post-wrapper { width: 100%; max-width: 600px; }
    .post-card { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    h2 { text-align: center; font-size: 1.8rem; color: #1f2937; margin-bottom: 5px; font-weight: bold; }
    .subtitle { text-align: center; color: #6b7280; margin-bottom: 30px; font-size: 0.95rem; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #374151; }
    .form-group input[type="text"], 
    .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; outline: none; transition: border-color 0.2s; box-sizing: border-box;}
    .form-group input:focus, .form-group textarea:focus { border-color: #2563eb; }
    .tag-select { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag-option { background: #f3f4f6; color: #4b5563; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; border: 1px solid transparent; transition: all 0.2s; select-none; user-select: none; }
    .tag-option:hover { background: #e5e7eb; }
    .tag-option.selected { background: #dbeafe; color: #1e40af; border-color: #2563eb; font-weight: bold; }
    .submit-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4); }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
    .back-link { display: block; text-align: center; margin-top: 20px; color: #6b7280; text-decoration: none; font-size: 0.9rem; }
    .success-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:9999; }
    .success-card { background:white; padding:30px; border-radius:10px; text-align:center; animation: popIn 0.5s ease; }
    .checkmark { font-size: 40px; margin-bottom: 10px; }
    @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body class="post-page">

  <div class="post-wrapper">
    <div class="post-card">
      <h2>ğŸ’¬ æ–°ã—ã„ç›¸è«‡ã‚’æŠ•ç¨¿ã™ã‚‹</h2>
      <p class="subtitle">ã‚ãªãŸã®æ‚©ã¿ãƒ»è³ªå•ã‚’ã‚·ã‚§ã‚¢ã—ã¦ã¿ã‚ˆã†</p>

      <form id="postForm">
        <div class="form-group">
          <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" id="title" placeholder="ä¾‹ï¼šAOå…¥è©¦ã§ä½¿ãˆã‚‹èª²å¤–æ´»å‹•ã«ã¤ã„ã¦" required>
        </div>

        <div class="form-group">
          <label for="content">å†…å®¹</label>
          <textarea id="content" rows="6" placeholder="è©³ã—ã„ç›¸è«‡å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„â€¦" required></textarea>
        </div>

        <div class="form-group">
          <label>ã‚¿ã‚°ã‚’é¸æŠ (åˆ¶é™ãªã—)</label>
          <div id="tagSelect" class="tag-select">
            <span class="tag-option" data-tag="ä¸€èˆ¬å…¥è©¦">#ä¸€èˆ¬å…¥è©¦</span>
            <span class="tag-option" data-tag="AOå…¥è©¦">#AOå…¥è©¦</span>
            <span class="tag-option" data-tag="DP">#DP</span>
            <span class="tag-option" data-tag="èª²å¤–æ´»å‹•">#èª²å¤–æ´»å‹•</span>
            <span class="tag-option" data-tag="å±¥ä¿®">#å±¥ä¿®</span>
            <span class="tag-option" data-tag="æµ·å¤–å¤§å­¦">#æµ·å¤–å¤§å­¦</span>
            <span class="tag-option" data-tag="éƒ¨æ´»">#éƒ¨æ´»</span>
            <span class="tag-option" data-tag="è‹±æ¤œ">#è‹±æ¤œ</span>
            <span class="tag-option" data-tag="IELTS">#IELTS</span>
            <span class="tag-option" data-tag="TOEFL">#TOEFL</span>
            <span class="tag-option" data-tag="æ¨¡è©¦">#æ¨¡è©¦</span>
          </div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">ğŸš€ æŠ•ç¨¿ã™ã‚‹</button>
      </form>

      <a href="archive.html" class="back-link">â† ä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwPtYMU_xiM5YgcqfNsCFESkj-Y4ICD5E",
      authDomain: "senpainet-84a24.firebaseapp.com",
      projectId: "senpainet-84a24",
      storageBucket: "senpainet-84a24.firebasestorage.app",
      messagingSenderId: "1053589632945",
      appId: "1:1053589632945:web:413919be47760675e4ef90",
      measurementId: "G-1GPKNSMMFZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // 1. ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
    onAuthStateChanged(auth, (user) => {
        if(!user) {
            signInAnonymously(auth);
        }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³å¾…æ©Ÿé–¢æ•°
    function ensureLogin() {
        return new Promise((resolve) => {
            if (auth.currentUser) {
                resolve(auth.currentUser);
                return;
            }
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    unsubscribe();
                    resolve(user);
                }
            });
        });
    }

    // 2. æŠ•ç¨¿ãƒ­ã‚¸ãƒƒã‚¯
    const postForm = document.getElementById("postForm");
    const submitBtn = document.getElementById("submitBtn");
    let selectedTags = [];
    
    // ã‚¿ã‚°é¸æŠ
    document.querySelectorAll(".tag-option").forEach(tag => {
        tag.addEventListener("click", () => {
            const tagName = tag.dataset.tag;
            if (selectedTags.includes(tagName)) {
                selectedTags = selectedTags.filter(t => t !== tagName);
                tag.classList.remove("selected");
            } else {
                selectedTags.push(tagName);
                tag.classList.add("selected");
            }
        });
    });

    // é€ä¿¡
    postForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const title = document.getElementById("title").value;
        const content = document.getElementById("content").value;

        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é€£æ‰“é˜²æ­¢ï¼†å¾…æ©Ÿè¡¨ç¤º
        submitBtn.disabled = true;
        submitBtn.textContent = "ğŸš€ æº–å‚™ä¸­...";

        try {
            // â˜… ã“ã“ã§ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’ç¢ºå®Ÿã«å¾…ã¤
            const user = await ensureLogin();
            submitBtn.textContent = "ğŸš€ é€ä¿¡ä¸­...";

            await addDoc(collection(db, "posts"), {
                title: title,
                content: content,
                tags: selectedTags,
                authorId: user.uid,
                nickname: user.displayName || "åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼",
                createdAt: serverTimestamp()
            });

            // æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const overlay = document.createElement("div");
            overlay.className = "success-overlay";
            overlay.innerHTML = `
                <div class="success-card">
                <div class="checkmark">âœ…</div>
                <h3>æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
                <p>ã‚ãªãŸã®ç›¸è«‡ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã€‚</p>
                </div>
            `;
            document.body.appendChild(overlay);

            setTimeout(() => {
                window.location.href = "archive.html"; 
            }, 2000);

        } catch (error) {
            console.error("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:", error);
            alert("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = "ğŸš€ æŠ•ç¨¿ã™ã‚‹";
        }
    });
  </script>
</body>
</html>
