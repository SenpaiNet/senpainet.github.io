<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç›¸è«‡è©³ç´° | SenpaiNet</title>
  <link rel="stylesheet" href="archive.css">
  <style>
    /* è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ä¸Šæ›¸ãã‚¹ã‚¿ã‚¤ãƒ« */
    .detail-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    /* è³ªå•éƒ¨åˆ† */
    .question-section {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      margin-bottom: 40px;
      border: 1px solid #f1f5f9;
    }
    .question-title { font-size: 1.8rem; margin-bottom: 15px; color: #1e3a8a; font-weight: 800; }
    .question-meta {
      display: flex; align-items: center; gap: 15px; color: #64748b; font-size: 0.9rem; margin-bottom: 25px;
      padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;
    }
    .question-body { font-size: 1.1rem; line-height: 1.8; color: #334155; white-space: pre-wrap; }

    /* å›ç­”ã‚¨ãƒªã‚¢ */
    .answers-section h3 {
      font-size: 1.4rem; color: #1e293b; margin-bottom: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .answers-section h3::before {
      content: ''; display: block; width: 6px; height: 24px;
      background: #4da6ff; border-radius: 10px;
    }
    
    .answer-card {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 25px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .answer-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px;
    }
    .answer-author { display: flex; align-items: center; gap: 10px; font-weight: 700; color: #334155; }
    .author-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
    
    .answer-date { font-size: 0.85rem; color: #94a3b8; }
    .answer-body { color: #475569; line-height: 1.6; font-size: 1rem; }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
    .answer-form-area {
      background: white; padding: 30px; border-radius: 20px;
      border: 2px solid #e2e8f0; margin-top: 50px;
    }
    textarea {
      width: 100%; height: 140px; padding: 15px;
      border: 2px solid #e2e8f0; border-radius: 12px;
      margin-bottom: 20px; font-size: 1rem; box-sizing: border-box;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: #3b82f6; outline: none; }
    
    .form-controls {
      display: flex; justify-content: space-between; align-items: center;
    }
    .anon-check { display: flex; align-items: center; cursor: pointer; color: #64748b; font-weight: 600; }
    
    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white; border: none; padding: 12px 30px;
      border-radius: 50px; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: transform 0.2s;
    }
    .submit-btn:hover { transform: translateY(-2px); }

    /* é€šå ±ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒªãƒ³ã‚¯ */
    .action-links { margin-left: auto; font-size: 0.8rem; }
    .action-link { color: #94a3b8; cursor: pointer; margin-left: 8px; text-decoration: none; }
    .action-link:hover { color: #ef4444; text-decoration: underline; }
  </style>
</head>
<body class="list-page">

  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <a href="index.html">SenpaiNet</a>
      </div>
      <nav class="navbar-menu">
        <a href="post.html">ç›¸è«‡ã™ã‚‹</a>
        <a href="archive.html" class="active">ç›¸è«‡ã‚’è¦‹ã‚‹</a>
        <a href="senpai.html">å…ˆè¼©ä¸€è¦§</a>
        <a href="form.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="#" class="account-btn">ãƒ­ã‚°ã‚¤ãƒ³</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="detail-container">
        <section class="question-section" id="qSection">
            <h1 id="qTitle" class="question-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
            <div id="qMeta" class="question-meta"></div>
            <div id="qTags" style="margin-bottom:20px; display:flex; gap:8px;"></div>
            <div id="qBody" class="question-body"></div>
        </section>

        <section class="answers-section">
            <h3>ã¿ã‚“ãªã®å›ç­”</h3>
            <div id="answersList"></div>
        </section>

        <section class="answer-form-area">
            <h3 style="margin-top:0;">å›ç­”ã™ã‚‹</h3>
            <form id="answerForm">
                <textarea id="answerInput" placeholder="å…ˆè¼©ã¨ã—ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’é€ã‚ã†..." required></textarea>
                <div class="form-controls">
                    <label class="anon-check">
                        <input type="checkbox" id="anonCheck">
                        <span style="margin-left: 8px;">åŒ¿åã§æŠ•ç¨¿</span>
                    </label>
                    <button type="submit" class="submit-btn">å›ç­”ã‚’é€ä¿¡</button>
                </div>
            </form>
        </section>
    </div>
  </main>

  <script type="module" src="firebase.js"></script>
  <script type="module" src="auth_header.js"></script> 
  <script type="module">
    import { db, auth } from "./firebase.js"; 
    import { doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, increment, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');
    let postAuthorId = null;
    let postTitle = "";
    
    let blockedUsers = []; // ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒªã‚¹ãƒˆ

    if (!postId) {
        window.location.href = "archive.html";
    }

    let currentUser = null;
    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if(user) {
            // ãƒ–ãƒ­ãƒƒã‚¯ãƒªã‚¹ãƒˆå–å¾—
            try {
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    blockedUsers = uDoc.data().blocked || [];
                }
            } catch(e) {}
        }
        loadQuestion(); 
    });

    // 1. è³ªå•è¡¨ç¤º
    async function loadQuestion() {
        const docRef = doc(db, "posts", postId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            postAuthorId = data.authorId;
            postTitle = data.title;
            
            // ãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®š
            if(blockedUsers.includes(postAuthorId)) {
                document.getElementById('qSection').innerHTML = "<p style='color:#999; text-align:center;'>ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã§ã™ã€‚</p>";
                return;
            }

            document.getElementById('qTitle').textContent = data.title;
            document.getElementById('qBody').textContent = data.content;
            
            const dateStr = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : "æ—¥ä»˜ä¸æ˜";
            const icon = data.authorIcon || "https://placehold.co/30";
            
            const metaContainer = document.getElementById('qMeta');
            let actionsHtml = "";
            
            if (currentUser && currentUser.uid !== postAuthorId) {
                actionsHtml = `
                    <div class="action-links">
                        <span class="action-link" onclick="reportUser('${postAuthorId}', 'post', '${postId}')">é€šå ±</span>
                        <span class="action-link" onclick="blockUser('${postAuthorId}')">ãƒ–ãƒ­ãƒƒã‚¯</span>
                    </div>
                `;
            } else if (currentUser && currentUser.uid === postAuthorId) {
                actionsHtml = `<button id="delPostBtn" style="margin-left: auto; background: #ef4444; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: bold;">å‰Šé™¤</button>`;
            }

            metaContainer.innerHTML = `
                <img src="${icon}" style="width:30px; height:30px; border-radius:50%; margin-right:10px; object-fit:cover;">
                <span>${data.authorName || 'åŒ¿å'}</span>
                <span style="margin: 0 10px;">|</span>
                <span>ğŸ“… ${dateStr}</span>
                ${actionsHtml}
            `;

            if(document.getElementById("delPostBtn")) {
                document.getElementById("delPostBtn").onclick = async () => {
                    if (confirm("æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                        await deleteDoc(docRef);
                        window.location.href = "archive.html";
                    }
                };
            }

            if(data.tags && data.tags.length > 0) {
                document.getElementById('qTags').innerHTML = data.tags.map(t => 
                    `<span style="background:#e0f2fe; color:#0284c7; padding:4px 10px; border-radius:20px; font-size:0.85rem; font-weight:600;">#${t}</span>`
                ).join("");
            }
        } else {
            document.querySelector('.detail-container').innerHTML = "<p>æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
        }
    }

    // 2. å›ç­”ä¸€è¦§
    function loadAnswers() {
        const answersRef = collection(db, "posts", postId, "answers");
        const q = query(answersRef, orderBy("createdAt", "asc"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('answersList');
            container.innerHTML = "";

            if(snapshot.empty) {
                container.innerHTML = "<p style='color:#888; padding:20px; text-align:center;'>ã¾ã å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®å›ç­”è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>";
                return;
            }

            snapshot.forEach((docSnapshot) => {
                const ans = docSnapshot.data();
                const ansId = docSnapshot.id;
                
                // ãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®š
                if(blockedUsers.includes(ans.authorId)) return; // è¡¨ç¤ºã—ãªã„

                const dateStr = ans.createdAt ? ans.createdAt.toDate().toLocaleString() : "ãŸã£ãŸä»Š";
                const icon = ans.authorIcon || "https://placehold.co/30";

                const likes = ans.likes || [];
                const likeCount = likes.length;
                const isLiked = currentUser && likes.includes(currentUser.uid);
                const heartColor = isLiked ? "#ff4757" : "#ccc";

                let ansActions = "";
                if(currentUser && currentUser.uid !== ans.authorId) {
                    ansActions = `
                        <div style="font-size:0.8rem;">
                            <span class="action-link" onclick="reportUser('${ans.authorId}', 'answer', '${ansId}')">é€šå ±</span>
                            <span class="action-link" onclick="blockUser('${ans.authorId}')">ãƒ–ãƒ­ãƒƒã‚¯</span>
                        </div>
                    `;
                }

                const html = `
                    <div class="answer-card">
                        <div class="answer-header">
                            <div class="answer-author">
                                <img src="${icon}" class="author-icon">
                                <span>${ans.authorName}</span>
                            </div>
                            <div class="answer-date">${dateStr}</div>
                        </div>
                        <div class="answer-body">${ans.content}</div>
                        
                        <div style="margin-top: 15px; display: flex; align-items: center; justify-content: space-between;">
                            <button onclick="toggleLike('${ansId}', ${isLiked})" style="background: transparent; border: 1px solid ${heartColor}; color: ${heartColor}; border-radius: 20px; padding: 4px 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; transition: 0.2s;">
                                <span>â™¥</span> ${likeCount}
                            </button>
                            ${ansActions}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        });
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°å®šç¾©
    window.toggleLike = async (ansId, isLiked) => {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        const ansRef = doc(db, "posts", postId, "answers", ansId);
        if (isLiked) {
            await updateDoc(ansRef, { likes: arrayRemove(currentUser.uid) });
        } else {
            await updateDoc(ansRef, { likes: arrayUnion(currentUser.uid) });
        }
    };

    window.blockUser = async (targetUid) => {
        if(!confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ\nä»Šå¾Œã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚„å›ç­”ã¯è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚")) return;
        try {
            await updateDoc(doc(db, "users", currentUser.uid), {
                blocked: arrayUnion(targetUid)
            });
            alert("ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚");
            window.location.reload();
        } catch(e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    };

    window.reportUser = async (targetUid, type, contentId) => {
        const reason = prompt("é€šå ±ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if(!reason) return;
        try {
            await addDoc(collection(db, "reports"), {
                reporterId: currentUser.uid,
                targetUserId: targetUid,
                contentType: type, // post or answer
                contentId: contentId,
                reason: reason,
                createdAt: serverTimestamp()
            });
            alert("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
        } catch(e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    };

    // 3. å›ç­”é€ä¿¡
    document.getElementById('answerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) { alert("å›ç­”ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }
        const content = document.getElementById('answerInput').value;
        const isAnon = document.getElementById('anonCheck').checked;
        if (!content.trim()) return;

        try {
            let userIcon = user.photoURL;
            let userName = user.displayName;
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if(userDoc.exists()) {
                    const ud = userDoc.data();
                    userIcon = ud.iconUrl || userIcon;
                    userName = ud.nickname || userName;
                }
            } catch(e){}

            await addDoc(collection(db, "posts", postId, "answers"), {
                content: content,
                authorId: user.uid,
                authorName: isAnon ? "åŒ¿åå¸Œæœ›" : (userName || "åç„¡ã—"),
                authorIcon: isAnon ? "https://placehold.co/30" : (userIcon || "https://placehold.co/30"),
                createdAt: serverTimestamp(),
                likes: [] 
            });

            await updateDoc(doc(db, "posts", postId), { replies: increment(1) });

            if (postAuthorId && postAuthorId !== user.uid) {
                await addDoc(collection(db, "users", postAuthorId, "notifications"), {
                    type: "reply",
                    postId: postId,
                    postTitle: postTitle,
                    fromName: isAnon ? "åŒ¿å" : (userName || "èª°ã‹"),
                    fromIcon: isAnon ? null : userIcon,
                    isRead: false,
                    createdAt: serverTimestamp()
                });
                // GASãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç­‰ã¯çœç•¥ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰åŒæ§˜ï¼‰
            }
            document.getElementById('answerInput').value = ""; 
        } catch (error) { console.error("Error:", error); alert("é€ä¿¡å¤±æ•—: " + error.message); }
    });

    loadAnswers();
  </script>
</body>
</html>
