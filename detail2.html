<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç›¸è«‡è©³ç´° | SenpaiNet</title>
  <link rel="stylesheet" href="archive.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <style>
    /* è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ä¸Šæ›¸ãã‚¹ã‚¿ã‚¤ãƒ« */
    .detail-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    /* è³ªå•éƒ¨åˆ† */
    .question-section {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      margin-bottom: 40px;
      border: 1px solid #f1f5f9;
      position: relative;
    }
    .question-title { font-size: 1.8rem; margin-bottom: 15px; color: #1e3a8a; font-weight: 800; }
    .question-meta {
      display: flex; align-items: center; gap: 15px; color: #64748b; font-size: 0.9rem; margin-bottom: 25px;
      padding-bottom: 20px; border-bottom: 1px solid #e2e8f0;
    }
    .question-body { font-size: 1.1rem; line-height: 1.8; color: #334155; }

    /* å›ç­”ã‚¨ãƒªã‚¢ */
    .answers-section h3 {
      font-size: 1.4rem; color: #1e293b; margin-bottom: 20px;
      display: flex; align-items: center; gap: 10px;
    }
    .answers-section h3::before {
      content: ''; display: block; width: 6px; height: 24px;
      background: #4da6ff; border-radius: 10px;
    }
    
    .answer-card {
      background: white;
      border: 1px solid #e2e8f0;
      padding: 25px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
      transition: all 0.3s;
    }
    .answer-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px;
    }
    .answer-author { display: flex; align-items: center; gap: 10px; font-weight: 700; color: #334155; }
    .author-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
    
    .answer-date { font-size: 0.85rem; color: #94a3b8; }
    .answer-body { color: #475569; line-height: 1.6; font-size: 1rem; }

    /* ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
    .answer-form-area {
      background: white; padding: 30px; border-radius: 20px;
      border: 2px solid #e2e8f0; margin-top: 50px;
    }
    textarea {
      width: 100%; height: 140px; padding: 15px;
      border: 2px solid #e2e8f0; border-radius: 12px;
      margin-bottom: 20px; font-size: 1rem; box-sizing: border-box;
      transition: border-color 0.2s;
    }
    textarea:focus { border-color: #3b82f6; outline: none; }
    
    .form-controls {
      display: flex; justify-content: space-between; align-items: center;
    }
    .anon-check { display: flex; align-items: center; cursor: pointer; color: #64748b; font-weight: 600; }
    
    .submit-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white; border: none; padding: 12px 30px;
      border-radius: 50px; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      transition: transform 0.2s;
    }
    .submit-btn:hover { transform: translateY(-2px); }

    /* é€šå ±ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ãƒªãƒ³ã‚¯ */
    .action-links { margin-left: auto; font-size: 0.8rem; }
    .action-link { color: #94a3b8; cursor: pointer; margin-left: 8px; text-decoration: none; }
    .action-link:hover { color: #ef4444; text-decoration: underline; }

    /* Markdown & æ•°å¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
      border-bottom: 1px solid #e2e8f0; padding-bottom: 0.3em; margin-top: 1.5em; margin-bottom: 16px; font-size:1.2em;
    }
    .markdown-body p { margin-bottom: 1em; white-space: normal; }
    .markdown-body blockquote {
      border-left: 4px solid #cbd5e1; color: #64748b; padding-left: 1em; margin: 0; background:#f8fafc; padding:8px;
    }
    .markdown-body code {
      background-color: #f1f5f9; padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em;
    }
    .markdown-body pre {
      background-color: #1e293b; color: #f8fafc; padding: 1em; border-radius: 8px; overflow-x: auto;
    }
    .markdown-body pre code { background-color: transparent; padding: 0; color: inherit; }
    .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; border: 1px solid #e2e8f0; }

    /* è§£æ±ºæ¸ˆã¿ãƒãƒƒã‚¸ */
    .status-badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 0.8rem; font-weight: bold; margin-bottom: 8px;
    }
    .status-solved { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .status-open { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }

    /* ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ */
    .best-answer-card {
      border: 2px solid #fbbf24 !important; background: #fffbeb !important; position: relative;
    }
    .best-answer-badge {
      position: absolute; top: -12px; right: 20px;
      background: #fbbf24; color: #92400e; font-weight: bold;
      padding: 4px 12px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.85rem; display: flex; align-items: center; gap: 4px;
    }

    /* ã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ (ãƒã‚¹ãƒˆ) */
    .nested-reply {
      margin-left: 40px; border-left: 3px solid #e2e8f0; background: #f8fafc; width: auto;
    }
    @media (max-width: 600px) { .nested-reply { margin-left: 15px; } }

    /* ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³ */
    .bookmark-btn {
      background: transparent; border: none; cursor: pointer; color: #cbd5e1;
      transition: all 0.2s; font-size: 1.5rem; line-height:1; margin-left:auto;
    }
    .bookmark-btn.active { color: #fbbf24; transform: scale(1.2); }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
    .post-actions { display: flex; gap: 15px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 15px; align-items: center; font-size:0.9rem;}
    .action-btn { background: none; border: none; cursor: pointer; color: #64748b; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
    .action-btn:hover { color: #3b82f6; }
  </style>
</head>
<body class="list-page">

  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <a href="index.html">SenpaiNet</a>
      </div>
      <nav class="navbar-menu">
        <a href="post.html">ç›¸è«‡ã™ã‚‹</a>
        <a href="archive.html" class="active">ç›¸è«‡ã‚’è¦‹ã‚‹</a>
        <a href="senpai.html">å…ˆè¼©ä¸€è¦§</a>
        <a href="form.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="#" class="account-btn">ãƒ­ã‚°ã‚¤ãƒ³</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="detail-container">
        <section class="question-section" id="qSection">
            <div id="statusBadgeArea"></div>
            
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h1 id="qTitle" class="question-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
                <button id="bookmarkBtn" class="bookmark-btn" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯">â˜…</button>
            </div>

            <div id="qMeta" class="question-meta"></div>
            <div id="qTags" style="margin-bottom:20px; display:flex; gap:8px;"></div>
            
            <div id="qBody" class="question-body markdown-body"></div>

            <div class="post-actions">
               <span id="viewCountArea" style="margin-right:auto; color:#94a3b8; font-size:0.85rem;">ğŸ‘€ 0 views</span>
               <button class="action-btn" onclick="quoteReply('qBody')">â†© å¼•ç”¨è¿”ä¿¡</button>
               <div id="ownerActions" style="display:none; gap:10px;">
                   </div>
            </div>
        </section>

        <section class="answers-section">
            <h3>ã¿ã‚“ãªã®å›ç­”</h3>
            <div id="answersList"></div>
        </section>

        <section class="answer-form-area" id="answerFormArea">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">å›ç­”ã™ã‚‹</h3>
                <span id="replyTargetDisplay" style="font-size:0.85rem; color:#64748b; display:none;">
                    è¿”ä¿¡å…ˆ: <span id="replyTargetName"></span> 
                    <button onclick="cancelReply()" style="border:none; background:none; color:#ef4444; cursor:pointer;">âœ• è§£é™¤</button>
                </span>
            </div>

            <form id="answerForm">
                <textarea id="answerInput" placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required></textarea>
                <div class="form-controls">
                    <label class="anon-check">
                        <input type="checkbox" id="anonCheck">
                        <span style="margin-left: 8px;">åŒ¿åã§æŠ•ç¨¿</span>
                    </label>
                    <button type="submit" class="submit-btn">å›ç­”ã‚’é€ä¿¡</button>
                </div>
            </form>
        </section>
    </div>
  </main>

  <script type="module" src="firebase.js"></script>
  <script type="module" src="auth_header.js"></script> 
  <script type="module">
    import { db, auth } from "./firebase.js"; 
    import { doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, increment, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const postId = new URL(location.href).searchParams.get('id');
    if (!postId) window.location.href = "archive.html";

    let currentUser = null;
    let currentUserSettings = {}; // â˜…è¿½åŠ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ä¿æŒ
    let postData = null;
    let blockedUsers = [];
    let replyParentId = null; // ã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡å…ˆID

    // Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
    function renderContent(text, elementId) {
        const el = document.getElementById(elementId);
        // Markdown -> HTML
        let html = marked.parse(text);
        // ã‚µãƒ‹ã‚¿ã‚¤ã‚º(XSSå¯¾ç­–)
        html = DOMPurify.sanitize(html);
        el.innerHTML = html;
        // æ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (KaTeX)
        renderMathInElement(el, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    }

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if(user) {
            try {
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if(uDoc.exists()) {
                    const ud = uDoc.data();
                    currentUserSettings = ud; // â˜…è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
                    blockedUsers = ud.blocked || [];
                    // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯çŠ¶æ…‹ç¢ºèª
                    if(ud.bookmarks && ud.bookmarks.includes(postId)) {
                        document.getElementById("bookmarkBtn").classList.add("active");
                    }
                }
                // é–²è¦§æ•°ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
                updateDoc(doc(db, "posts", postId), { viewCount: increment(1) }).catch(()=>{});
            } catch(e) {}
        }
        loadQuestion(); 
    });

    // 1. è³ªå•è¡¨ç¤º
    async function loadQuestion() {
        const docRef = doc(db, "posts", postId);
        
        onSnapshot(docRef, (docSnap) => {
            if (!docSnap.exists()) {
                document.querySelector('.detail-container').innerHTML = "<p>æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>";
                return;
            }

            postData = docSnap.data();
            
            // ãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®š
            if(blockedUsers.includes(postData.authorId)) {
                document.getElementById('qSection').innerHTML = "<p style='color:#999; text-align:center;'>ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã§ã™ã€‚</p>";
                return;
            }

            document.getElementById('qTitle').textContent = postData.title;
            // Markdownã¨ã—ã¦æç”»
            renderContent(postData.content, 'qBody');
            
            // è§£æ±ºæ¸ˆã¿ãƒãƒƒã‚¸
            const badgeArea = document.getElementById("statusBadgeArea");
            if(postData.isSolved) {
                badgeArea.innerHTML = `<span class="status-badge status-solved">âœ“ è§£æ±ºæ¸ˆã¿</span>`;
            } else {
                badgeArea.innerHTML = `<span class="status-badge status-open">å›ç­”å‹Ÿé›†ä¸­</span>`;
            }

            // é–²è¦§æ•°
            document.getElementById("viewCountArea").textContent = `ğŸ‘€ ${postData.viewCount || 0} views`;

            const dateStr = postData.createdAt ? postData.createdAt.toDate().toLocaleDateString() : "æ—¥ä»˜ä¸æ˜";
            const icon = postData.authorIcon || "https://placehold.co/30";
            
            // ãƒ¡ã‚¿æƒ…å ±ï¼†æ“ä½œãƒœã‚¿ãƒ³
            const metaContainer = document.getElementById('qMeta');
            let actionsHtml = "";
            
            if (currentUser && currentUser.uid !== postData.authorId) {
                actionsHtml = `
                    <div class="action-links">
                        <span class="action-link" onclick="reportUser('${postData.authorId}', 'post', '${postId}')">é€šå ±</span>
                        <span class="action-link" onclick="blockUser('${postData.authorId}')">ãƒ–ãƒ­ãƒƒã‚¯</span>
                    </div>
                `;
            }

            metaContainer.innerHTML = `
                <img src="${icon}" style="width:30px; height:30px; border-radius:50%; margin-right:10px; object-fit:cover;">
                <span>${postData.authorName || 'åŒ¿å'}</span>
                <span style="margin: 0 10px;">|</span>
                <span>ğŸ“… ${dateStr}</span>
                ${actionsHtml}
            `;

            // ã‚¿ã‚°
            if(postData.tags && postData.tags.length > 0) {
                document.getElementById('qTags').innerHTML = postData.tags.map(t => 
                    `<span style="background:#e0f2fe; color:#0284c7; padding:4px 10px; border-radius:20px; font-size:0.85rem; font-weight:600;">#${t}</span>`
                ).join("");
            }

            // æŠ•ç¨¿è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (å‰Šé™¤ã€è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹)
            const ownerActions = document.getElementById("ownerActions");
            if(currentUser && currentUser.uid === postData.authorId) {
                ownerActions.style.display = "flex";
                ownerActions.style.alignItems = "center"; // â˜…è¦‹æ „ãˆèª¿æ•´

                // â˜…é€šçŸ¥è¨­å®šã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’æ±ºå®š
                // è¨­å®šãŒãªã„(undefined)ã¾ãŸã¯trueã®å ´åˆã¯ONã€falseã®å ´åˆã®ã¿OFF
                const isNotifEnabled = (currentUserSettings.allowAnswerNotification !== false);
                const checkedState = isNotifEnabled ? "checked" : "";

                let btns = "";
                
                // â˜…é€šçŸ¥ã‚¹ã‚¤ãƒƒãƒã‚’è¿½åŠ 
                btns += `
                    <label style="cursor:pointer; display:flex; align-items:center; gap:4px; margin-right:15px; font-size:0.9rem; color:#475569; background:#f1f5f9; padding:4px 10px; border-radius:15px;">
                        <input type="checkbox" onchange="toggleEmailNotification(this)" ${checkedState}>
                        ğŸ“© é€šçŸ¥ã‚’å—ã‘å–ã‚‹
                    </label>
                `;

                // è§£æ±ºãƒœã‚¿ãƒ³
                if(!postData.isSolved) {
                    btns += `<button class="action-btn" onclick="markAsSolved()">âœ“ è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹</button>`;
                }
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³
                btns += `<button class="action-btn" onclick="deleteMyPost()" style="color:#ef4444;">ğŸ—‘ å‰Šé™¤</button>`;
                
                ownerActions.innerHTML = btns;
            }
        });
    }

    // 2. å›ç­”ä¸€è¦§ (ã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ)
    function loadAnswers() {
        const answersRef = collection(db, "posts", postId, "answers");
        const q = query(answersRef, orderBy("createdAt", "asc"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('answersList');
            container.innerHTML = "";

            if(snapshot.empty) {
                container.innerHTML = "<p style='color:#888; padding:20px; text-align:center;'>ã¾ã å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®å›ç­”è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>";
                return;
            }

            const answers = [];
            snapshot.forEach(d => answers.push({id: d.id, ...d.data()}));

            // ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤º
            const rootAnswers = answers.filter(a => !a.parentId);
            
            rootAnswers.forEach(ans => {
                if(blockedUsers.includes(ans.authorId)) return;
                renderAnswerCard(ans, container, false); // è¦ª

                // å­ã‚’æ¢ã™
                const children = answers.filter(a => a.parentId === ans.id);
                children.forEach(child => {
                    if(blockedUsers.includes(child.authorId)) return;
                    renderAnswerCard(child, container, true); // å­ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚ã‚Š)
                });
            });
        });
    }

    function renderAnswerCard(ans, container, isNested) {
        const isBest = (postData && postData.bestAnswerId === ans.id);
        const div = document.createElement("div");
        div.className = `answer-card ${isNested ? "nested-reply" : ""} ${isBest ? "best-answer-card" : ""}`;
        
        const bestBadge = isBest ? `<div class="best-answer-badge">ğŸ‘‘ ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼</div>` : "";
        const dateStr = ans.createdAt ? ans.createdAt.toDate().toLocaleString() : "ãŸã£ãŸä»Š";
        const icon = ans.authorIcon || "https://placehold.co/30";
        const likes = ans.likes || [];
        const likeCount = likes.length;
        const isLiked = currentUser && likes.includes(currentUser.uid);
        const heartColor = isLiked ? "#ff4757" : "#ccc";

        // ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼é¸æŠãƒœã‚¿ãƒ³ (æŠ•ç¨¿è€…ã‹ã¤æœªè§£æ±ºã®å ´åˆ)
        let baButton = "";
        if(postData && !postData.isSolved && currentUser && currentUser.uid === postData.authorId) {
            baButton = `<button onclick="selectBestAnswer('${ans.id}')" style="font-size:0.8rem; background:#fbbf24; border:none; border-radius:12px; padding:4px 8px; cursor:pointer;">ğŸ‘‘ ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã™ã‚‹</button>`;
        }

        let ansActions = "";
        if(currentUser && currentUser.uid !== ans.authorId) {
            ansActions = `
                <span class="action-link" onclick="reportUser('${ans.authorId}', 'answer', '${ans.id}')">é€šå ±</span>
                <span class="action-link" onclick="blockUser('${ans.authorId}')">ãƒ–ãƒ­ãƒƒã‚¯</span>
            `;
        }

        const bodyId = `ansBody-${ans.id}`;

        div.innerHTML = `
            ${bestBadge}
            <div class="answer-header">
                <div class="answer-author">
                    <img src="${icon}" class="author-icon">
                    <span>${ans.authorName}</span>
                </div>
                <div class="answer-date">${dateStr}</div>
            </div>
            
            <div id="${bodyId}" class="answer-body markdown-body"></div>
            
            <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <button onclick="toggleLike('${ans.id}', ${isLiked})" style="background: transparent; border: 1px solid ${heartColor}; color: ${heartColor}; border-radius: 20px; padding: 4px 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; transition: 0.2s;">
                    <span>â™¥</span> ${likeCount}
                </button>
                <button class="action-btn" onclick="setReplyTarget('${ans.id}', '${ans.authorName}')">â†© è¿”ä¿¡</button>
                ${baButton}
                <div style="margin-left:auto; font-size:0.8rem;">${ansActions}</div>
            </div>
        `;
        container.appendChild(div);
        
        // Markdownæç”»
        renderContent(ans.content, bodyId);
    }


    // === ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° (windowã«ç™»éŒ²) ===
    
    // â˜…è¿½åŠ : é€šçŸ¥è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆ
    window.toggleEmailNotification = async (checkbox) => {
        if(!currentUser) return;
        const newValue = checkbox.checked;
        try {
            await updateDoc(doc(db, "users", currentUser.uid), {
                allowAnswerNotification: newValue
            });
            // ãƒ­ãƒ¼ã‚«ãƒ«ã®è¨­å®šã‚‚æ›´æ–°ï¼ˆå†èª­ã¿è¾¼ã¿ãªã—ã§åæ˜ ã•ã›ã‚‹ãŸã‚ï¼‰
            currentUserSettings.allowAnswerNotification = newValue;
        } catch(e) {
            console.error("è¨­å®šæ›´æ–°ã‚¨ãƒ©ãƒ¼", e);
            alert("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            checkbox.checked = !newValue; // å…ƒã«æˆ»ã™
        }
    };

    window.toggleLike = async (ansId, isLiked) => {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        const ansRef = doc(db, "posts", postId, "answers", ansId);
        if (isLiked) {
            await updateDoc(ansRef, { likes: arrayRemove(currentUser.uid) });
        } else {
            await updateDoc(ansRef, { likes: arrayUnion(currentUser.uid) });
        }
    };

    window.markAsSolved = async () => {
        if(confirm("è§£æ±ºæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ")) {
            await updateDoc(doc(db, "posts", postId), { isSolved: true });
        }
    };

    window.selectBestAnswer = async (ansId) => {
        if(confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«æ±ºå®šã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè§£æ±ºæ¸ˆã¿ã«ãªã‚Šã¾ã™ï¼‰")) {
            await updateDoc(doc(db, "posts", postId), { 
                bestAnswerId: ansId,
                isSolved: true 
            });
        }
    };

    window.quoteReply = (elementId) => {
        const text = document.getElementById(elementId).innerText;
        const input = document.getElementById("answerInput");
        const lines = text.split("\n").map(l => `> ${l}`).join("\n");
        input.value += `\n${lines}\n\n`;
        input.focus();
        document.getElementById("answerFormArea").scrollIntoView({behavior:"smooth"});
    };

    window.setReplyTarget = (pid, name) => {
        replyParentId = pid;
        document.getElementById("replyTargetDisplay").style.display = "inline-block";
        document.getElementById("replyTargetName").textContent = name;
        document.getElementById("answerFormArea").scrollIntoView({behavior:"smooth"});
    };

    window.cancelReply = () => {
        replyParentId = null;
        document.getElementById("replyTargetDisplay").style.display = "none";
    };

    window.deleteMyPost = async () => {
        if (confirm("æœ¬å½“ã«ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            await deleteDoc(doc(db, "posts", postId));
            window.location.href = "archive.html";
        }
    };

    window.blockUser = async (targetUid) => {
        if(!confirm("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            await updateDoc(doc(db, "users", currentUser.uid), {
                blocked: arrayUnion(targetUid)
            });
            alert("ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸã€‚");
            window.location.reload();
        } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
    };

    window.reportUser = async (targetUid, type, contentId) => {
        const reason = prompt("é€šå ±ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if(!reason) return;
        try {
            await addDoc(collection(db, "reports"), {
                reporterId: currentUser.uid,
                targetUserId: targetUid,
                contentType: type,
                contentId: contentId,
                reason: reason,
                createdAt: serverTimestamp()
            });
            alert("é€šå ±ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚");
        } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
    };


    // ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å‡¦ç†
    document.getElementById("bookmarkBtn").addEventListener("click", async () => {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const btn = document.getElementById("bookmarkBtn");
        const isActive = btn.classList.contains("active");
        const ref = doc(db, "users", currentUser.uid);
        
        if(isActive) {
            await updateDoc(ref, { bookmarks: arrayRemove(postId) });
            btn.classList.remove("active");
        } else {
            await updateDoc(ref, { bookmarks: arrayUnion(postId) });
            btn.classList.add("active");
        }
    });


    // 3. å›ç­”é€ä¿¡
    document.getElementById('answerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = auth.currentUser;
        if (!user) { alert("å›ç­”ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚"); return; }
        const content = document.getElementById('answerInput').value;
        const isAnon = document.getElementById('anonCheck').checked;
        if (!content.trim()) return;

        try {
            let userIcon = user.photoURL;
            let userName = user.displayName;
            try {
                // currentUserSettings ãŒã‚ã‚Œã°ãã“ã‹ã‚‰å–ã‚‹ï¼ˆé«˜é€ŸåŒ–ï¼‰
                if(currentUserSettings.nickname) userName = currentUserSettings.nickname;
                if(currentUserSettings.iconUrl) userIcon = currentUserSettings.iconUrl;
            } catch(e){}

            await addDoc(collection(db, "posts", postId, "answers"), {
                content: content,
                authorId: user.uid,
                authorName: isAnon ? "åŒ¿åå¸Œæœ›" : (userName || "åç„¡ã—"),
                authorIcon: isAnon ? "https://placehold.co/30" : (userIcon || "https://placehold.co/30"),
                createdAt: serverTimestamp(),
                likes: [],
                parentId: replyParentId // ã‚¹ãƒ¬ãƒƒãƒ‰ID
            });

            await updateDoc(doc(db, "posts", postId), { 
                replies: increment(1),
                lastUpdatedAt: serverTimestamp() // æ›´æ–°é †ç”¨
            });

            // é€šçŸ¥å‡¦ç†
            if (postData.authorId && postData.authorId !== user.uid) {
                await addDoc(collection(db, "users", postData.authorId, "notifications"), {
                    type: "reply",
                    postId: postId,
                    postTitle: postData.title,
                    fromName: isAnon ? "åŒ¿å" : (userName || "èª°ã‹"),
                    fromIcon: isAnon ? null : userIcon,
                    isRead: false,
                    createdAt: serverTimestamp()
                });
            }
            
            document.getElementById('answerInput').value = ""; 
            cancelReply();
        } catch (error) { console.error("Error:", error); alert("é€ä¿¡å¤±æ•—: " + error.message); }
    });

    loadAnswers();
  </script>
</body>
</html>
