<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç›¸è«‡è©³ç´° | SenpaiNet</title>
  <link rel="stylesheet" href="archive.css">
  <style>
    /* è©³ç´°ãƒšãƒ¼ã‚¸å°‚ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
    .detail-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    /* è³ªå•éƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æµç”¨ã—ã¤ã¤å¼·èª¿ï¼‰ */
    .question-section {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }
    .question-title { font-size: 1.5rem; margin-bottom: 1rem; color: #333; }
    .question-meta { font-size: 0.9rem; color: #888; margin-bottom: 1.5rem; display: flex; gap: 10px; align-items: center;}
    .question-body { font-size: 1.1rem; line-height: 1.6; white-space: pre-wrap; }

    /* å›ç­”ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .answers-section h3 { margin-bottom: 1rem; border-left: 5px solid #4ecdc4; padding-left: 10px; }
    
    .answer-card {
      background: #f9f9f9;
      border: 1px solid #eee;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .answer-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .answer-author { font-weight: bold; color: #555; display: flex; align-items: center; gap: 8px;}
    .author-tag {
        font-size: 0.75rem;
        background: #e0f7fa;
        color: #006064;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #b2ebf2;
    }
    .answer-date { color: #aaa; }

    /* å›ç­”ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .answer-form-area {
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      margin-top: 3rem;
      border-top: 4px solid #eee;
    }
    textarea {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 1rem;
      resize: vertical;
    }
    .form-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .anon-check {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }
    .submit-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 24px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    .submit-btn:hover { background: #ff5252; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Firebaseè¨­å®šï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyCwPtYMU_xiM5YgcqfNsCFESkj-Y4ICD5E",
      authDomain: "senpainet-84a24.firebaseapp.com",
      projectId: "senpainet-84a24",
      storageBucket: "senpainet-84a24.firebasestorage.app",
      messagingSenderId: "1053589632945",
      appId: "1:1053589632945:web:413919be47760675e4ef90",
      measurementId: "G-1GPKNSMMFZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æŠ•ç¨¿IDã‚’å–å¾— (?id=xxxxx)
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    if (!postId) {
        alert("æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        window.location.href = "archive.html";
    }

    // 1. è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function loadQuestion() {
        const docRef = doc(db, "posts", postId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('qTitle').textContent = data.title;
            document.getElementById('qBody').textContent = data.content; // ã¾ãŸã¯ body
            document.getElementById('qMeta').textContent = `æŠ•ç¨¿è€…: ${data.authorName || 'åŒ¿å'} | ${data.createdAt?.toDate().toLocaleDateString()}`;
        } else {
            document.querySelector('.detail-container').innerHTML = "<p>æŠ•ç¨¿ãŒå‰Šé™¤ã•ã‚ŒãŸã‹ã€å­˜åœ¨ã—ã¾ã›ã‚“ã€‚</p>";
        }
    }

    // 2. å›ç­”ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function loadAnswers() {
        // postsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸­ã®ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ "answers" ã‚’å‚ç…§
        const answersRef = collection(db, "posts", postId, "answers");
        const q = query(answersRef, orderBy("createdAt", "asc"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('answersList');
            container.innerHTML = ""; // ãƒªã‚»ãƒƒãƒˆ

            if(snapshot.empty) {
                container.innerHTML = "<p style='color:#888;'>ã¾ã å›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®å›ç­”è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>";
                return;
            }

            snapshot.forEach((doc) => {
                const ans = doc.data();
                const dateStr = ans.createdAt ? ans.createdAt.toDate().toLocaleString() : "ãŸã£ãŸä»Š";
                
                // ã‚¿ã‚°ã®è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
                let tagsHtml = "";
                if(ans.authorTags && Array.isArray(ans.authorTags) && ans.authorTags.length > 0) {
                    tagsHtml = ans.authorTags.map(tag => `<span class="author-tag">${tag}</span>`).join("");
                }

                const html = `
                    <div class="answer-card">
                        <div class="answer-header">
                            <div class="answer-author">
                                ${ans.authorName}
                                ${tagsHtml}
                            </div>
                            <div class="answer-date">${dateStr}</div>
                        </div>
                        <div class="answer-body">${ans.content}</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        });
    }

    // 3. å›ç­”ã‚’æŠ•ç¨¿ã™ã‚‹é–¢æ•°
    const answerForm = document.getElementById('answerForm');
    answerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const user = auth.currentUser;
        if (!user) {
            alert("å›ç­”ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
            return;
        }

        const content = document.getElementById('answerInput').value;
        const isAnon = document.getElementById('anonCheck').checked;

        if (!content.trim()) return;

        // â˜…ã“ã“ã§æœ¬æ¥ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¿ã‚°ã‚’å–å¾—ã™ã‚‹
        // ä»Šå›ã¯ä»®ã« user.photoURL ãªã©ã‚’ã‚¿ã‚°ä»£ã‚ã‚Šã«ä½¿ã†ã‹ã€åˆ¥é€”fetchãŒå¿…è¦
        // ã“ã“ã§ã¯ç°¡å˜ã®ãŸã‚ã€ã‚‚ã—Useræƒ…å ±ã«ã‚¿ã‚°ãŒã‚ã‚Œã°ä½¿ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¾ã™
        let userTags = []; 
        // ä¾‹: const userDoc = await getDoc(doc(db, "users", user.uid));
        // if(userDoc.exists()) userTags = userDoc.data().tags; 

        try {
            await addDoc(collection(db, "posts", postId, "answers"), {
                content: content,
                authorId: user.uid,
                authorName: isAnon ? "åŒ¿åå¸Œæœ›ã•ã‚“" : (user.displayName || "åç„¡ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼"),
                authorTags: isAnon ? [] : userTags, // åŒ¿åãªã‚‰ã‚¿ã‚°ã‚‚éš ã™ã€ãã†ã§ãªã‘ã‚Œã°ã‚¿ã‚°ä»˜ä¸
                createdAt: serverTimestamp()
            });

            document.getElementById('answerInput').value = ""; // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            alert("å›ç­”ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
        } catch (error) {
            console.error("Error:", error);
            alert("æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
    });

    // åˆæœŸå®Ÿè¡Œ
    loadQuestion();
    loadAnswers();

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆarchive.htmlã¨åŒã˜ï¼‰
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        signOut(auth).then(() => {
          alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
          window.location.href = "login.html";
        });
      });
    }
  </script>
</head>
<body class="list-page">

  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo">
        <a href="index.html">SenpaiNet</a>
      </div>
      <nav class="navbar-menu">
        <a href="post.html">ç›¸è«‡ã™ã‚‹</a>
        <a href="archive.html" class="active">ç›¸è«‡ã‚’è¦‹ã‚‹</a>
        <a href="#">å®Ÿç¸¾</a>
        <a href="#">ãŠå•ã„åˆã‚ã›</a>
        <a href="#" id="logoutBtn" class="account-link" style="color: #ff6b6b;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="detail-container">
        <section class="question-section">
            <h1 id="qTitle" class="question-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
            <div id="qMeta" class="question-meta"></div>
            <hr style="border:0; border-top:1px solid #eee; margin: 1rem 0;">
            <div id="qBody" class="question-body"></div>
        </section>

        <section class="answers-section">
            <h3>ã¿ã‚“ãªã®å›ç­”</h3>
            <div id="answersList">
                </div>
        </section>

        <section class="answer-form-area">
            <h3>å›ç­”ã™ã‚‹</h3>
            <form id="answerForm">
                <textarea id="answerInput" placeholder="ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚„å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required></textarea>
                <div class="form-controls">
                    <label class="anon-check">
                        <input type="checkbox" id="anonCheck">
                        <span style="margin-left: 8px;">åŒ¿åï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’ä¼ã›ã‚‹ï¼‰</span>
                    </label>
                    <button type="submit" class="submit-btn">æŠ•ç¨¿ã™ã‚‹</button>
                </div>
            </form>
        </section>
    </div>
  </main>
<script type="module" src="auth_header.js"></script>
</body>
</html>
