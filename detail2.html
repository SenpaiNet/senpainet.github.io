<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç›¸è«‡è©³ç´° | SenpaiNet</title>
  <link rel="stylesheet" href="archive.css">
  <link rel="stylesheet" href="style.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <style>
    .detail-container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
    .question-section { background: white; padding: 40px; border-radius: 20px; border: 1px solid #f1f5f9; margin-bottom: 40px; position:relative; }
    
    .post-actions { display: flex; gap: 15px; margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 15px; align-items: center; }
    .action-btn { background: none; border: none; cursor: pointer; color: #64748b; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
    .action-btn:hover { color: #3b82f6; }
    .answer-card { margin-bottom: 20px; transition: all 0.3s; }
  </style>
</head>
<body class="list-page">

  <header class="navbar">
    <div class="navbar-container">
      <div class="navbar-logo"><a href="index.html">SenpaiNet</a></div>
      <nav class="navbar-menu">
        <a href="post.html">ç›¸è«‡ã™ã‚‹</a>
        <a href="archive.html" class="active">ç›¸è«‡ã‚’è¦‹ã‚‹</a>
        <a href="senpai.html">å…ˆè¼©ä¸€è¦§</a>
        <a href="#" class="account-btn">ãƒ­ã‚°ã‚¤ãƒ³</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="detail-container">
        <section class="question-section" id="qSection">
            <div id="statusBadgeArea"></div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <h1 id="qTitle" class="question-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
                <button id="bookmarkBtn" class="bookmark-btn" title="ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯">â˜…</button>
            </div>
            
            <div id="qMeta" class="question-meta"></div>
            <div id="qTags" style="margin-bottom:20px; display:flex; gap:8px;"></div>
            
            <div id="qBody" class="question-body markdown-body"></div>

            <div class="post-actions">
               <span id="viewCountArea" style="margin-right:auto; color:#94a3b8; font-size:0.85rem;">ğŸ‘€ 0 views</span>
               <button class="action-btn" onclick="quoteReply('qBody')">â†© å¼•ç”¨è¿”ä¿¡</button>
               <div id="ownerActions" style="display:none; gap:10px;"></div>
            </div>
        </section>

        <section class="answers-section">
            <h3>ã¿ã‚“ãªã®å›ç­”</h3>
            <div id="answersList"></div>
        </section>

        <section class="answer-form-area" id="answerFormArea">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">å›ç­”ã™ã‚‹</h3>
                <span id="replyTargetDisplay" style="font-size:0.85rem; color:#64748b; display:none;">
                    è¿”ä¿¡å…ˆ: <span id="replyTargetName"></span> 
                    <button onclick="cancelReply()" style="border:none; background:none; color:red; cursor:pointer;">âœ• è§£é™¤</button>
                </span>
            </div>
            
            <form id="answerForm">
                <textarea id="answerInput" placeholder="Markownè¨˜æ³•ãŒä½¿ãˆã¾ã™ã€‚&#10;æ•°å¼ã¯ $...$ ã§å›²ã‚“ã§ãã ã•ã„ã€‚" required></textarea>
                <div class="form-controls">
                    <label class="anon-check">
                        <input type="checkbox" id="anonCheck">
                        <span style="margin-left: 8px;">åŒ¿åã§æŠ•ç¨¿</span>
                    </label>
                    <button type="submit" class="submit-btn">å›ç­”ã‚’é€ä¿¡</button>
                </div>
            </form>
        </section>
    </div>
  </main>

  <script type="module" src="firebase.js"></script>
  <script type="module" src="auth_header.js"></script> 
  <script type="module">
    import { db, auth } from "./firebase.js"; 
    import { doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, increment, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const postId = new URL(location.href).searchParams.get('id');
    if (!postId) window.location.href = "archive.html";

    let currentUser = null;
    let postData = null;
    let replyParentId = null;

    function renderContent(text, elementId) {
        const el = document.getElementById(elementId);
        let html = marked.parse(text);
        html = DOMPurify.sanitize(html);
        el.innerHTML = html;
        renderMathInElement(el, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    }

    onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if(user) {
            updateDoc(doc(db, "posts", postId), { viewCount: increment(1) }).catch(()=>{});
            checkBookmark();
        }
        loadQuestion(); 
    });

    async function checkBookmark() {
        if(!currentUser) return;
        const uDoc = await getDoc(doc(db, "users", currentUser.uid));
        if(uDoc.exists()) {
            const bks = uDoc.data().bookmarks || [];
            if(bks.includes(postId)) document.getElementById("bookmarkBtn").classList.add("active");
        }
    }

    document.getElementById("bookmarkBtn").addEventListener("click", async () => {
        if(!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const btn = document.getElementById("bookmarkBtn");
        const isActive = btn.classList.contains("active");
        const ref = doc(db, "users", currentUser.uid);
        
        if(isActive) {
            await updateDoc(ref, { bookmarks: arrayRemove(postId) });
            btn.classList.remove("active");
        } else {
            await updateDoc(ref, { bookmarks: arrayUnion(postId) });
            btn.classList.add("active");
        }
    });

    async function loadQuestion() {
        const docRef = doc(db, "posts", postId);
        onSnapshot(docRef, (docSnap) => {
            if (!docSnap.exists()) return;
            postData = docSnap.data();
            
            document.getElementById('qTitle').textContent = postData.title;
            renderContent(postData.content, 'qBody');
            
            const badgeArea = document.getElementById("statusBadgeArea");
            if(postData.isSolved) {
                badgeArea.innerHTML = `<span class="status-badge status-solved">âœ“ è§£æ±ºæ¸ˆã¿</span>`;
            } else {
                badgeArea.innerHTML = `<span class="status-badge status-open">å›ç­”å‹Ÿé›†ä¸­</span>`;
            }

            document.getElementById("viewCountArea").textContent = `ğŸ‘€ ${postData.viewCount || 0} views`;

            const dateStr = postData.createdAt ? postData.createdAt.toDate().toLocaleDateString() : "-";
            const updateStr = postData.lastUpdatedAt ? postData.lastUpdatedAt.toDate().toLocaleDateString() : dateStr;
            const icon = postData.authorIcon || "https://placehold.co/30";
            
            document.getElementById('qMeta').innerHTML = `
                <img src="${icon}" style="width:30px; height:30px; border-radius:50%; margin-right:10px;">
                <span>${postData.authorName}</span> | ğŸ“… ${dateStr} (ğŸ”„ ${updateStr})
            `;
            
            if(postData.tags) {
                document.getElementById('qTags').innerHTML = postData.tags.map(t => 
                    `<span class="tag" style="background:#e0f2fe; padding:4px 8px; border-radius:12px;">#${t}</span>`
                ).join("");
            }

            if(currentUser && currentUser.uid === postData.authorId) {
                const actions = document.getElementById("ownerActions");
                actions.style.display = "flex";
                if(!postData.isSolved) {
                    actions.innerHTML = `<button class="action-btn" onclick="markAsSolved()">âœ“ è§£æ±ºæ¸ˆã¿ã«ã™ã‚‹</button>`;
                } else {
                    actions.innerHTML = "";
                }
            }
        });
    }

    function loadAnswers() {
        const answersRef = collection(db, "posts", postId, "answers");
        const q = query(answersRef, orderBy("createdAt", "asc"));

        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('answersList');
            container.innerHTML = "";
            
            const answers = [];
            snapshot.forEach(d => answers.push({id: d.id, ...d.data()}));

            const rootAnswers = answers.filter(a => !a.parentId);
            
            rootAnswers.forEach(ans => {
                renderAnswerCard(ans, container, false);
                const children = answers.filter(a => a.parentId === ans.id);
                children.forEach(child => {
                    renderAnswerCard(child, container, true);
                });
            });
        });
    }

    function renderAnswerCard(ans, container, isNested) {
        const isBest = (postData && postData.bestAnswerId === ans.id);
        const div = document.createElement("div");
        div.className = `answer-card ${isNested ? "nested-reply" : ""} ${isBest ? "best-answer-card" : ""}`;
        
        const bestBadge = isBest ? `<div class="best-answer-badge">ğŸ‘‘ ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼</div>` : "";
        const icon = ans.authorIcon || "https://placehold.co/30";
        const dateStr = ans.createdAt ? ans.createdAt.toDate().toLocaleString() : "";
        
        let baButton = "";
        if(postData && !postData.isSolved && currentUser && currentUser.uid === postData.authorId) {
            baButton = `<button onclick="selectBestAnswer('${ans.id}')" style="font-size:0.8rem; background:#fbbf24; border:none; border-radius:12px; padding:4px 8px; cursor:pointer;">ğŸ‘‘ ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã™ã‚‹</button>`;
        }

        const bodyId = `ansBody-${ans.id}`;

        div.innerHTML = `
            ${bestBadge}
            <div class="answer-header">
                <div class="answer-author">
                    <img src="${icon}" class="author-icon"> <span>${ans.authorName}</span>
                </div>
                <div style="font-size:0.8rem; color:#999;">${dateStr}</div>
            </div>
            <div id="${bodyId}" class="answer-body markdown-body"></div>
            
            <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                 <button onclick="toggleLike('${ans.id}')" style="background:none; border:1px solid #ccc; border-radius:20px; padding:2px 10px; font-size:0.8rem; cursor:pointer;">
                    â¤ï¸ ã‚ã‚ŠãŒã¨ã† ${(ans.likes||[]).length}
                 </button>
                 <button class="action-btn" onclick="setReplyTarget('${ans.id}', '${ans.authorName}')">â†© è¿”ä¿¡</button>
                 ${baButton}
            </div>
        `;
        container.appendChild(div);
        
        renderContent(ans.content, bodyId);
    }

    window.markAsSolved = async () => {
        if(confirm("è§£æ±ºæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ")) {
            await updateDoc(doc(db, "posts", postId), { isSolved: true });
        }
    };
    window.selectBestAnswer = async (ansId) => {
        if(confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«æ±ºå®šã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè§£æ±ºæ¸ˆã¿ã«ãªã‚Šã¾ã™ï¼‰")) {
            await updateDoc(doc(db, "posts", postId), { 
                bestAnswerId: ansId,
                isSolved: true 
            });
        }
    };
    window.quoteReply = (elementId) => {
        const text = document.getElementById(elementId).innerText;
        const input = document.getElementById("answerInput");
        const lines = text.split("\n").map(l => `> ${l}`).join("\n");
        input.value += `\n${lines}\n\n`;
        input.focus();
        document.getElementById("answerFormArea").scrollIntoView({behavior:"smooth"});
    };
    window.setReplyTarget = (pid, name) => {
        replyParentId = pid;
        document.getElementById("replyTargetDisplay").style.display = "inline-block";
        document.getElementById("replyTargetName").textContent = name;
        document.getElementById("answerFormArea").scrollIntoView({behavior:"smooth"});
    };
    window.cancelReply = () => {
        replyParentId = null;
        document.getElementById("replyTargetDisplay").style.display = "none";
    };

    window.toggleLike = async (ansId) => {
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        const ansRef = doc(db, "posts", postId, "answers", ansId);
        // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€ŒæŠ¼ã™ãŸã³ã«è‡ªåˆ†ã®UIDã‚’è¿½åŠ /å‰Šé™¤ã€ã™ã‚‹ãƒˆã‚°ãƒ«ã‚’æƒ³å®š
        const docSnap = await getDoc(ansRef);
        if(!docSnap.exists()) return;
        const likes = docSnap.data().likes || [];
        if(likes.includes(currentUser.uid)) {
            await updateDoc(ansRef, { likes: arrayRemove(currentUser.uid) });
        } else {
            await updateDoc(ansRef, { likes: arrayUnion(currentUser.uid) });
        }
    };

    document.getElementById('answerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        const content = document.getElementById('answerInput').value;
        const isAnon = document.getElementById('anonCheck').checked;

        try {
            await addDoc(collection(db, "posts", postId, "answers"), {
                content: content,
                authorId: currentUser.uid,
                authorName: isAnon ? "åŒ¿åå¸Œæœ›" : (currentUser.displayName || "åç„¡ã—"),
                authorIcon: isAnon ? "https://placehold.co/30" : (currentUser.photoURL || null),
                createdAt: serverTimestamp(),
                likes: [],
                parentId: replyParentId
            });
            await updateDoc(doc(db, "posts", postId), { 
                replies: increment(1),
                lastUpdatedAt: serverTimestamp()
            });
            document.getElementById('answerInput').value = "";
            cancelReply();
        } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
    });

    loadAnswers();
  </script>
</body>
</html>
